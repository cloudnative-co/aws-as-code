{
    "schemaVersion": "0.3",
    "description": "Install-ADDSForest",
    "parameters": {
        "domainName": {
            "type": "String",
            "description": "FQDN Domain Name for ADDS"
        },
        "domainNetBiosName": {
            "type": "String",
            "description": "Domain NetBIOS Name for ADDS"
        },
        "forestMode": {
            "type": "String",
            "default": "WinThreshold",
            "description": "Accept Values: Win2008, Win2008R2, Win2012, Win2012R2, WinThreshold, Default"
        },
        "domainMode": {
            "type": "String",
            "default": "WinThreshold",
            "description": "Accept Values: Win2008, Win2008R2, Win2012, Win2012R2, WinThreshold, Default"
        }
    },
    "mainSteps": [
        {
            "action": "aws:runCommand",
            "name": "installwindowsfeature",
            "nextStep": "setadminpassword",
            "inputs": {
                "DocumentName": "AWS-RunPowerShellScript",
                "Parameters": {
                    "commands": [
                        "install-windowsfeature AD-Domain-Services"
                    ]
                }
            }
        },
        {
            "action": "aws:runCommand",
            "name": "setadminpassword",
            "nextStep": "installaddsforest",
            "inputs": {
                "DocumentName": "AWS-RunPowerShellScript",
                "Parameters": {
                    "commands": [
                        "$password = Get-SECSecretValue -SecretId AdminPassword | Select-Object SecretString",
                        "$encrypted_password = ConvertTo-SecureString $password -AsPlainText -Force",
                        "Set-LocalUser -Name Administrator -Password $encrypted_password -PasswordNeverExpires:$true"
                    ]
                }
            }
        },
        {
            "action": "aws:runCommand",
            "name": "installaddsforest",
            "nextStep": "addssmusertodomainadmin",
            "inputs": {
                "DocumentName": "AWS-RunPowerShellScript",
                "Parameters": {
                    "commands": [
                        "$password = Get-SECSecretValue -SecretId AdminPassword | Select-Object SecretString",
                        "$encrypted_password = ConvertTo-SecureString $password -AsPlainText -Force",
                        "Import-Module ADDSDeployment",
                        "Install-ADDSForest -DomainName {{ domainName }} -DomainNetbiosName {{ domainNetBiosName }} -ForestMode {{ forestMode }} -DomainMode {{ domainMode }} -SafeModeAdministratorPassword $encrypted_password -DatabasePath \"C:\\Windows\\NTDS\" -LogPath \"C:\\Windows\\NTDS\" -SysvolPath \"C:\\Windows\\SYSVOL\" -InstallDns:$true -CreateDnsDelegation:$false -NoRebootOnCompletion:$false -Force:$true"
                    ]
                }
            }
        },
        {
            "action": "aws:runCommand",
            "name": "addssmusertodomainadmin",
            "inputs": {
                "DocumentName": "AWS-RunPowerShellScript",
                "Parameters": {
                    "commands": [
                        "New-ADUser ssm-user",
                        "Add-ADPrincipalGroupMembership ssm-user -memberOf \"Domain Admins\""
                    ]
                }
            }
        }
    ]
}
